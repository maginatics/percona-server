# Test for Bug 13867871 - ROW_INS_CHECK_FOREIGN_CONSTRAINT() ACCESSES
# FREED DICT_INDEX_T
--source include/have_innodb.inc
--source include/have_debug_sync.inc

CREATE TABLE ibtest11a (A INT, D INT, B VARCHAR(20), C VARCHAR(75), PRIMARY KEY (A, D, B), INDEX (B, C), INDEX (C)) ENGINE = INNODB;

CREATE TABLE ibtest11c (A INT, D INT, B VARCHAR(20), C VARCHAR(75), PRIMARY KEY (A, D, B), INDEX (B, C), INDEX (C), FOREIGN KEY (A, D) REFERENCES ibtest11a (A, D) ON DELETE CASCADE ON UPDATE CASCADE, CONSTRAINT kukkuu FOREIGN KEY (B, C) REFERENCES ibtest11a (B, C) ON DELETE CASCADE ON UPDATE CASCADE) ENGINE = INNODB;

INSERT INTO ibtest11a VALUES (1, 5, 'khD','khD');

connect (con1,localhost,root,,);

connection con1;

SET DEBUG_SYNC='foreign_constraint_check_for_ins WAIT_FOR drop_done';
--send
INSERT INTO ibtest11c VALUES (1, 5, 'khD','khD');

# drop the original FK index "B" on table ibtest11a while above
# insert blcoked in dict_foreign_replace_index()
connection default;
CREATE INDEX idx1 ON ibtest11a(B, C);
DROP INDEX B ON ibtest11a;
SET DEBUG_SYNC='now SIGNAL drop_done';

# Now test deleting an index on ibtest11c

connection con1;
reap;
SET DEBUG_SYNC='foreign_constraint_check_for_update WAIT_FOR drop_done';
--send
DELETE FROM ibtest11a WHERE A=1;

# drop the original FK index "B" on table ibtest11a while above
# insert blcoked in dict_foreign_replace_index()
connection default;
CREATE INDEX idx ON ibtest11c(B, C);
DROP INDEX B ON ibtest11c;
SET DEBUG_SYNC='now SIGNAL drop_done';

-- sleep 2

SELECT * FROM ibtest11c;
SELECT * FROM ibtest11a;

connection con1;
reap;

# Test cascade update case

INSERT INTO ibtest11a VALUES (1, 5, 'khD','khD');

INSERT INTO ibtest11c VALUES (1, 5, 'khD','khD');

SET DEBUG_SYNC='foreign_constraint_check_for_update WAIT_FOR drop_done';
--send
UPDATE ibtest11a SET A=2;

# drop the original FK index "idx" on table ibtest11a while above
# insert blocked in dict_foreign_replace_index()
connection default;

ALTER TABLE ibtest11c ADD INDEX idx_2(B, C), DROP INDEX idx, ALGORITHM=INPLACE;

SET DEBUG_SYNC='now SIGNAL drop_done';

connection con1;
reap;
disconnect con1;

CONNECTION default;
-- sleep 1
SELECT * FROM ibtest11c;
SELECT * FROM ibtest11a;

DROP TABLE ibtest11c;
DROP TABLE ibtest11a;

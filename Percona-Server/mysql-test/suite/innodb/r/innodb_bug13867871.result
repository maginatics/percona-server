CREATE TABLE ibtest11a (A INT, D INT, B VARCHAR(20), C VARCHAR(75), PRIMARY KEY (A, D, B), INDEX (B, C), INDEX (C)) ENGINE = INNODB;
CREATE TABLE ibtest11c (A INT, D INT, B VARCHAR(20), C VARCHAR(75), PRIMARY KEY (A, D, B), INDEX (B, C), INDEX (C), FOREIGN KEY (A, D) REFERENCES ibtest11a (A, D) ON DELETE CASCADE ON UPDATE CASCADE, CONSTRAINT kukkuu FOREIGN KEY (B, C) REFERENCES ibtest11a (B, C) ON DELETE CASCADE ON UPDATE CASCADE) ENGINE = INNODB;
INSERT INTO ibtest11a VALUES (1, 5, 'khD','khD');
SET DEBUG_SYNC='foreign_constraint_check_for_ins WAIT_FOR drop_done';
INSERT INTO ibtest11c VALUES (1, 5, 'khD','khD');
CREATE INDEX idx1 ON ibtest11a(B, C);
DROP INDEX B ON ibtest11a;
SET DEBUG_SYNC='now SIGNAL drop_done';
SET DEBUG_SYNC='foreign_constraint_check_for_update WAIT_FOR drop_done';
DELETE FROM ibtest11a WHERE A=1;
CREATE INDEX idx ON ibtest11c(B, C);
DROP INDEX B ON ibtest11c;
SET DEBUG_SYNC='now SIGNAL drop_done';
SELECT * FROM ibtest11c;
A	D	B	C
SELECT * FROM ibtest11a;
A	D	B	C
INSERT INTO ibtest11a VALUES (1, 5, 'khD','khD');
INSERT INTO ibtest11c VALUES (1, 5, 'khD','khD');
SET DEBUG_SYNC='foreign_constraint_check_for_update WAIT_FOR drop_done';
UPDATE ibtest11a SET A=2;
ALTER TABLE ibtest11c ADD INDEX idx_2(B, C), DROP INDEX idx, ALGORITHM=INPLACE;
SET DEBUG_SYNC='now SIGNAL drop_done';
SELECT * FROM ibtest11c;
A	D	B	C
2	5	khD	khD
SELECT * FROM ibtest11a;
A	D	B	C
2	5	khD	khD
DROP TABLE ibtest11c;
DROP TABLE ibtest11a;

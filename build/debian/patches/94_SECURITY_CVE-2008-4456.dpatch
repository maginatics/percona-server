#! /bin/sh /usr/share/dpatch/dpatch-run
## 99_SECURITY_CVE-2008-4456.dpatch by Devin Carraway <devin@debian.org>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Third-party fix for CVE-2008-4456, addressing missing entity encoding
## of special characters in HTML output, potentially enabling script
## injection or other HTML tampering.

@DPATCH@
diff -aruN mysql-dfsg-5.0-5.0.32.orig/client/mysql.cc mysql-dfsg-5.0-5.0.32.CVE-2008-4456/client/mysql.cc
--- mysql-dfsg-5.0-5.0.32.orig/client/mysql.cc	2006-12-20 11:14:28.000000000 +0000
+++ mysql-dfsg-5.0-5.0.32.CVE-2008-4456/client/mysql.cc	2009-02-23 07:27:19.000000000 +0000
@@ -2499,9 +2499,12 @@
   {
     while((field = mysql_fetch_field(result)))
     {
-      tee_fprintf(PAGER, "<TH>%s</TH>", (field->name ? 
-					 (field->name[0] ? field->name : 
-					  " &nbsp; ") : "NULL"));
+      tee_fputs("<TH>", PAGER);
+      if (field->name && field->name[0])
+        xmlencode_print(field->name, field->name_length);
+      else
+        tee_fputs(field->name ? " &nbsp; " : "NULL", PAGER);
+      tee_fputs("</TH>", PAGER);
     }
     (void) tee_fputs("</TR>", PAGER);
   }
@@ -2512,7 +2515,7 @@
     for (uint i=0; i < mysql_num_fields(result); i++)
     {
       (void) tee_fputs("<TD>", PAGER);
-      safe_put_field(cur[i],lengths[i]);
+      xmlencode_print(cur[i], lengths[i]);
       (void) tee_fputs("</TD>", PAGER);
     }
     (void) tee_fputs("</TR>", PAGER);

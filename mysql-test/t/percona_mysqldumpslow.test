--source include/have_debug.inc
--source include/have_innodb_plugin.inc
--source include/count_sessions.inc
SET @old_long_query_time=@@long_query_time;
SET @old_log_slow_verbosity=@@log_slow_verbosity;
SET @old_log_slow_timestamp_every=@@log_slow_timestamp_every;
SET @old_log_slow_sp_statements=@@log_slow_sp_statements;
SET @old_slow_query_log_microseconds_timestamp=@@slow_query_log_microseconds_timestamp;
SET @old_log_slow_admin_statements=@@log_slow_admin_statements;
SET @old_min_examined_row_limit=@@min_examined_row_limit;

--disable_warnings
DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t2;
--enable_warnings

SET GLOBAL min_examined_row_limit=0;
SET GLOBAL long_query_time=0;
--let log_file=percona.mysqldumpslow

--let log_slow_timestamp_every_counter=2
while($log_slow_timestamp_every_counter)
{
--let log_slow_timestamp_every=`SELECT ($log_slow_timestamp_every_counter - 1)`

# log_slow_verbosity: microtime
--let log_slow_verbosity_microtime_counter=2
while($log_slow_verbosity_microtime_counter)
{
--let log_slow_verbosity_microtime=`SELECT ($log_slow_verbosity_microtime_counter - 1)`

# log_slow_verbosity: query_plan
--let log_slow_verbosity_query_plan_counter=2
while($log_slow_verbosity_query_plan_counter)
{
--let log_slow_verbosity_query_plan=`SELECT ($log_slow_verbosity_query_plan_counter - 1)`

# log_slow_verbosity: innodb
--let log_slow_verbosity_innodb_counter=2
while($log_slow_verbosity_innodb_counter)
{
--let log_slow_verbosity_innodb=`SELECT ($log_slow_verbosity_innodb_counter - 1)`

# log_slow_sp_statements
--let log_slow_sp_statements_counter=2

while($log_slow_sp_statements_counter)
{
--let log_slow_sp_statements=`SELECT ($log_slow_sp_statements_counter - 1)`

# slow_query_log_microseconds_timestamp
--let slow_query_log_microseconds_timestamp_counter=2

while($slow_query_log_microseconds_timestamp_counter)
{
--let slow_query_log_microseconds_timestamp=`SELECT ($slow_query_log_microseconds_timestamp_counter - 1)`

# log_slow_admin_statements
--let log_slow_admin_statements_counter=2

while($log_slow_admin_statements_counter)
{
--let log_slow_admin_statements=`SELECT ($log_slow_admin_statements_counter - 1)`

#
# Begin of setup slow query log options
#


# Setup log_slow_verbosity
--let log_slow_verbosity_value=
--let log_slow_verbosity_value_counter=0;

# Set log_slow_verbosity: microtime
if ($log_slow_verbosity_microtime)
{

if ($log_slow_verbosity_value_counter)
{
--let log_slow_verbosity_value=,$log_slow_verbosity_value
}

--let log_slow_verbosity_value=microtime$log_slow_verbosity_value

inc $log_slow_verbosity_value_counter;
}

# Set log_slow_verbosity: query_plan
if ($log_slow_verbosity_query_plan)
{

if ($log_slow_verbosity_value_counter)
{
--let log_slow_verbosity_value=,$log_slow_verbosity_value
}

--let log_slow_verbosity_value=query_plan$log_slow_verbosity_value

inc $log_slow_verbosity_value_counter;
}

# Set log_slow_verbosity: innodb
if ($log_slow_verbosity_innodb)
{

if ($log_slow_verbosity_value_counter)
{
--let log_slow_verbosity_value=,$log_slow_verbosity_value
}

--let log_slow_verbosity_value=innodb$log_slow_verbosity_value

inc $log_slow_verbosity_value_counter;
}

eval SET GLOBAL log_slow_verbosity='$log_slow_verbosity_value';
eval SET GLOBAL log_slow_timestamp_every=$log_slow_timestamp_every;
eval SET GLOBAL log_slow_sp_statements=$log_slow_sp_statements;
eval SET GLOBAL slow_query_log_microseconds_timestamp=$slow_query_log_microseconds_timestamp;
eval SET GLOBAL log_slow_admin_statements=$log_slow_admin_statements;

--connect (conn,localhost,root)
--connection conn

--source include/log_start.inc
SET SESSION query_exec_time=1.11;
SET SESSION slow_query_log_query_time=1.11;
SET SESSION slow_query_log_lock_time=0.1;
CREATE TABLE t1(id INT) ENGINE=InnoDB;
SET SESSION query_exec_time=1.22;
SET SESSION slow_query_log_query_time=1.22;
SET SESSION slow_query_log_lock_time=0.2;
CREATE TABLE t2(id INT) ENGINE=MyISAM;
SET SESSION query_exec_time=1.33;
SET SESSION slow_query_log_query_time=1.33;
SET SESSION slow_query_log_lock_time=0.3;
INSERT INTO t1 VALUES(0);
SET SESSION query_exec_time=1.44;
SET SESSION slow_query_log_query_time=1.44;
SET SESSION slow_query_log_lock_time=0.4;
INSERT INTO t1 VALUES(1);
SET SESSION query_exec_time=1.55;
SET SESSION slow_query_log_query_time=1.55;
SET SESSION slow_query_log_lock_time=0.5;
INSERT INTO t1 VALUES(2);
SET SESSION query_exec_time=1.66;
SET SESSION slow_query_log_query_time=1.66;
SET SESSION slow_query_log_lock_time=0.6;
INSERT INTO t1 SELECT * FROM t1 ORDER BY id DESC;
SET SESSION query_exec_time=1.77;
SET SESSION slow_query_log_query_time=1.77;
SET SESSION slow_query_log_lock_time=0.7;
INSERT INTO t1 SELECT * FROM t1 ORDER BY id ASC;
SET SESSION query_exec_time=1.88;
SET SESSION slow_query_log_query_time=1.88;
SET SESSION slow_query_log_lock_time=0.8;
INSERT INTO t2 SELECT * FROM t1 ORDER BY id DESC;
SET SESSION query_exec_time=1.99;
SET SESSION slow_query_log_query_time=1.99;
SET SESSION slow_query_log_lock_time=0.9;
INSERT INTO t2 SELECT * FROM t1 ORDER BY id ASC;
SET SESSION query_exec_time=2.1;
SET SESSION slow_query_log_query_time=2.1;
SET SESSION slow_query_log_lock_time=1.0;
SELECT COUNT(*) FROM t1;
SET SESSION query_exec_time=2.21;
SET SESSION slow_query_log_query_time=2.21;
SET SESSION slow_query_log_lock_time=1.1;
SELECT COUNT(*) FROM t2;
SET SESSION query_exec_time=2.32;
SET SESSION slow_query_log_query_time=2.32;
SET SESSION slow_query_log_lock_time=1.2;
DROP TABLE t1;
SET SESSION query_exec_time=2.43;
SET SESSION slow_query_log_query_time=2.43;
SET SESSION slow_query_log_lock_time=1.3;
DROP TABLE t2;
# When bug 1098857 is fixed, move the the next line after the session count wait
# and uncomment the three SET statements.
--source include/log_stop.inc
# SET SESSION query_exec_time=2.54;
# SET SESSION slow_query_log_query_time=2.54;
# SET SESSION slow_query_log_lock_time=1.4;
--connection default
--disconnect conn
--source include/wait_until_count_sessions.inc

dec $log_slow_admin_statements_counter;
}

dec $slow_query_log_microseconds_timestamp_counter;
}

dec $log_slow_sp_statements_counter;
}

dec $log_slow_verbosity_innodb_counter;
}

dec $log_slow_verbosity_query_plan_counter;
}

dec $log_slow_verbosity_microtime_counter;
}

dec $log_slow_timestamp_every_counter;
}

SET GLOBAL long_query_time=@old_long_query_time;
SET GLOBAL min_examined_row_limit=@old_min_examined_row_limit;
SET GLOBAL log_slow_verbosity=@old_log_slow_verbosity;
SET GLOBAL log_slow_timestamp_every=@old_log_slow_timestamp_every;
SET GLOBAL log_slow_sp_statements=@old_log_slow_sp_statements;
SET GLOBAL slow_query_log_microseconds_timestamp=@old_slow_query_log_microseconds_timestamp;
SET GLOBAL log_slow_admin_statements=@old_log_slow_admin_statements;

--let grep_pattern= CREATE TABLE t1\(id INT\) ENGINE=InnoDB;
--source include/log_grep.inc
--let grep_pattern= CREATE TABLE t2\(id INT\) ENGINE=MyISAM;
--source include/log_grep.inc
--let grep_pattern= INSERT INTO t1 VALUES\(0\);
--source include/log_grep.inc
--let grep_pattern= INSERT INTO t1 VALUES\(1\);
--source include/log_grep.inc
--let grep_pattern= INSERT INTO t1 VALUES\(2\);
--source include/log_grep.inc
--let grep_pattern= INSERT INTO t1 SELECT \* FROM t1 ORDER BY id DESC;
--source include/log_grep.inc
--let grep_pattern= INSERT INTO t1 SELECT \* FROM t1 ORDER BY id ASC;
--source include/log_grep.inc
--let grep_pattern= INSERT INTO t2 SELECT \* FROM t1 ORDER BY id DESC;
--source include/log_grep.inc
--let grep_pattern= INSERT INTO t2 SELECT \* FROM t1 ORDER BY id ASC;
--source include/log_grep.inc
--let grep_pattern= SELECT COUNT\(\*\) FROM t1;
--source include/log_grep.inc
--let grep_pattern= SELECT COUNT\(\*\) FROM t2;
--source include/log_grep.inc
--let grep_pattern= DROP TABLE t1;
--source include/log_grep.inc
--let grep_pattern= DROP TABLE t2;
--source include/log_grep.inc
# Uncomment after bug 1098857 is fixed
# --let grep_pattern= Quit
# --source include/log_grep.inc

# s/-t 11/-t 12/ after bug 1098857 is fixed
exec $MYSQLDUMPSLOW -t 11 $log_file_full_path;
--source include/log_cleanup.inc
